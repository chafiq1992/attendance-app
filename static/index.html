<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f7f9fc;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
      }
      img#logo {
        width: 120px;
        margin: 20px 0 10px 0;
      }
      h2 {
        margin: 5px 0 15px 0;
      }
      #employeeName {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
      }
      #status {
        color: #007BFF;
        font-size: 20px;
        margin-bottom: 10px;
      }
      #datetime {
        color: #555;
        font-size: 18px;
        margin-bottom: 20px;
      }
      .section {
        width: 90%;
        max-width: 500px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 20px;
        margin-bottom: 30px;
      }
      .section button {
        padding: 40px;
        font-size: 24px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        width: 100%;
        height: 120px;
      }
      .clockin { background-color: #4CAF50; color: white; }
      .clockout { background-color: #f44336; color: white; }
      .startbreak { background-color: #ff9800; color: white; }
      .endbreak { background-color: #2196f3; color: white; }
      .startextra { background-color: #673ab7; color: white; }
      .endextra { background-color: #9c27b0; color: white; }
      #msg {
        margin-top: 30px;
        font-size: 18px;
        text-align: center;
        min-height: 30px;
      }
      #day-log {
        margin: 20px 0 0 0;
        width: 90%;
        max-width: 500px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px #0001;
        padding: 20px 16px 10px 16px;
        font-size: 17px;
      }
      .log-section { margin-bottom: 12px; }
      .log-title { font-weight: bold; margin-bottom: 2px; color: #444; }
      .log-entry { margin-left: 14px; }
      .log-total { color: #007BFF; margin-top: 4px; font-size: 15px; margin-left: 12px; }
      /* Modal styles */
      #modalConfirm {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0; top: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.32);
        align-items: center; justify-content: center;
      }
      #modalConfirm .modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 30px 22px 16px 22px;
        box-shadow: 0 4px 24px #0002;
        text-align: center;
        max-width: 350px;
        margin: auto;
      }
      #modalConfirm p { font-size: 20px; margin: 0 0 18px 0; }
      #modalConfirm .modal-time { font-size: 17px; color: #007BFF; margin-bottom: 18px; }
      #modalConfirm button {
        background: #4CAF50;
        color: #fff;
        border: none;
        font-size: 19px;
        padding: 10px 28px;
        border-radius: 8px;
        cursor: pointer;
      }
      #tabs { margin-bottom: 12px; }
      #tabs button {
        border:none; padding:10px 18px; font-size:17px; cursor:pointer;
        border-radius:8px 8px 0 0; background:#ddd;
      }
      #tabs button.active { background:#007BFF; color:#fff; }
      #monthTable table { border-collapse:collapse; font-size:14px; }
      #monthTable th, #monthTable td { border:1px solid #ccc; padding:4px 6px; text-align:center; }
      #monthTable th { background:#f0f0f0; }
    </style>
  </head>
  <body>
    <img id="logo" src="https://cdn.shopify.com/s/files/1/0573/6726/5337/files/0df2.png?v=1697554869" alt="Company Logo">
    <h2>üïí Employee Attendance</h2>
    <h3 id="employeeName"></h3>
    <div id="tabs">
      <button id="tabDaily"  class="active">üïë Today</button>
      <button id="tabMonth">üìà Month Summary</button>
    </div>
    <div id="dailyView">
    <div id="status">Status: Not Clocked In</div>
    <div id="datetime"></div>
    <!-- Main actions -->
    <div class="section">
      <button class="clockin" onclick="showModal('clockin')">‚úÖ Clock In</button>
      <button class="clockout" onclick="showModal('clockout')">üïî Clock Out</button>
    </div>
    <div class="section">
      <button class="startbreak" onclick="showModal('startbreak')">üõë Start Break</button>
      <button class="endbreak" onclick="showModal('endbreak')">‚úÖ End Break</button>
    </div>
    <div class="section">
      <button class="startextra" onclick="showModal('startextra')">‚ûï Start Extra Hours</button>
      <button class="endextra" onclick="showModal('endextra')">üõë End Extra Hours</button>
    </div>
    <!-- New: Log of today's actions -->
    <div id="day-log">
      <div class="log-section" id="main-log"></div>
      <div class="log-section" id="break-log"></div>
      <div class="log-section" id="extra-log"></div>
    </div>
    <div id="msg"></div>

    <!-- Modal for confirmation -->
    <div id="modalConfirm">
      <div class="modal-content">
        <p id="modalMsg"></p>
        <div class="modal-time" id="modalTime"></div>
        <button onclick="confirmAction()">OK</button>
      </div>
    </div>
    </div>
    <div id="monthView" style="display:none">
      <h3>üìà This Month</h3>
      <div id="monthSummary">Loading‚Ä¶</div>
      <div id="monthTable" style="overflow-x:auto"></div>
    </div>

    <script>
      /* ------------------------------------------
         0.  Get the employee from ?employee=‚Ä¶ or localStorage
      -------------------------------------------*/
      const urlParams    = new URLSearchParams(location.search);
      let employeeName   = urlParams.get('employee') || localStorage.getItem('employee_name') || '';

      if (!employeeName) {
        alert('No employee supplied in the URL, e.g.  ?employee=hind');
      } else {
        localStorage.setItem('employee_name', employeeName);
        document.getElementById('employeeName').innerText = employeeName;
      }

      /* ------------------------------------------
         1.  Tiny helper that hits the same host that served the page
      -------------------------------------------*/
      const API     = location.origin.replace(/\/$/, '');
      const headers = { 'Content-Type': 'application/json' };
      const apiPost = (p, body={}) =>
            fetch(`${API}${p}`, {method:'POST', headers, body:JSON.stringify(body)})
              .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t); }));

      let breakStartTime = null, extraStartTime = null, mainStartTime = null;
      let pendingAction = null;

      // ==== Persistent log state for today ====

      // Load today's logs from localStorage (or empty log structure)
      let todayLogs = loadTodayLogs();
      let openPeriods = getOpenPeriodsFromLogs(todayLogs);

      // --- Persistence Helpers ---

      // Get string key for today (YYYY-MM-DD)
      function getTodayKey() {
        const now = new Date();
        // Pad month and date for correct sort order
        let mm = String(now.getMonth() + 1).padStart(2, '0');
        let dd = String(now.getDate()).padStart(2, '0');
        return now.getFullYear() + "-" + mm + "-" + dd;
      }

      // Load logs for today from localStorage
      function loadTodayLogs() {
        let key = "attendanceLog_" + getTodayKey();
        let raw = localStorage.getItem(key);
        if (raw) {
          // Restore JS Date objects from strings
          let logs = JSON.parse(raw);
          ['main','break','extra'].forEach(cat => {
            logs[cat] = logs[cat].map(ev => ({...ev, time: new Date(ev.time)}));
          });
          return logs;
        }
        return { main: [], break: [], extra: [] };
      }

      // Save logs for today to localStorage
      function saveTodayLogs() {
        let key = "attendanceLog_" + getTodayKey();
        localStorage.setItem(key, JSON.stringify(todayLogs));
      }

      // Infer open periods from logs
      function getOpenPeriodsFromLogs(logs) {
        let open = { main: null, break: null, extra: null };
        ['main','break','extra'].forEach(cat => {
          let lastIn = null;
          logs[cat].forEach(ev => {
            if (ev.type === 'in') lastIn = ev.time;
            if (ev.type === 'out') lastIn = null;
          });
          open[cat] = lastIn;
        });
        return open;
      }

      // ===============================

      window.onload = function() {
        if (!employeeName) {
          document.getElementById('employeeName').innerText = '‚õî No employee!';
          Array.from(document.querySelectorAll('button')).forEach(btn => btn.disabled = true);
          return;
        }
        startClock();
        renderDayLog();
      };

      function startClock() {
        setInterval(() => {
          const now = new Date();
          document.getElementById('datetime').innerText = now.toLocaleString();
        }, 1000);
      }

      function showModal(action) {
        // Custom modal message and time
        let msg = '', category = '', totalMin = 0;
        let now = new Date();
        let duration = getCurrentDuration(action, now);

        switch(action) {
          case 'clockin':
            msg = `üö™ Welcome to work, ${employeeName}! üåû We wish you a nice and happy work day. You are at the door and about to start the day. Let's make it a good one!`;
            category = 'main';
            break;
          case 'clockout':
            msg = `üïî Great job today, ${employeeName}! We hope you had a great day at work and you gave your best. üôè Thank you for your effort! Are you sure you want to clock out? See you tomorrow!`;
            category = 'main';
            break;
          case 'startbreak':
            msg = `üçΩÔ∏è ${employeeName}, you are about to go to lunch. Have a good meal! üòã Enjoy your break and recharge your energy.`;
            category = 'break';
            break;
          case 'endbreak':
            msg = `üíº Welcome back, ${employeeName}! You are about to return to work from your lunch break. Ready to get back to it? Let's finish strong! üí™`;
            category = 'break';
            break;
          case 'startextra':
            msg = `‚è∞ ${employeeName}, you are about to start extra hours. Thank you for your dedication! üöÄ`;
            category = 'extra';
            break;
          case 'endextra':
            msg = `üõë ${employeeName}, you are about to finish your extra hours. Thank you for going the extra mile! üôå`;
            category = 'extra';
          break;
        }


        // Show running total before action is confirmed
        totalMin = getCategoryTotalMinutes(category, now, (action.endsWith('in') || action.startsWith('start')) ? false : true);

        let humanTime = formatDuration(totalMin);
        document.getElementById('modalMsg').innerText = msg;
        document.getElementById('modalTime').innerText = `Total running time for this part: ${humanTime}`;
        document.getElementById('modalConfirm').style.display = 'flex';
        pendingAction = action;
      }

      function confirmAction() {
        document.getElementById('modalConfirm').style.display = 'none';
        submitAttendance(pendingAction);
        pendingAction = null;
      }

      function submitAttendance(action) {
        document.getElementById("msg").innerHTML = "‚è≥ <em>Submitting attendance...</em>";

        if (!employeeName) {
          document.getElementById("msg").innerText = "‚õî Error: No employee name set.";
          return;
        }

        const now = new Date();

        // --- Log the action and update open periods ---
        if (action === 'clockin') {
          document.getElementById("status").innerText = "Status: Clocked In ‚úÖ";
          todayLogs.main.push({ type: 'in', time: now });
          openPeriods.main = now;
        } else if (action === 'clockout') {
          document.getElementById("status").innerText = "Status: Clocked Out üïî";
          todayLogs.main.push({ type: 'out', time: now });
          openPeriods.main = null;
        } else if (action === 'startbreak') {
          document.getElementById("status").innerText = "Status: On Break üõë";
          todayLogs.break.push({ type: 'in', time: now });
          openPeriods.break = now;
        } else if (action === 'endbreak') {
          document.getElementById("status").innerText = "Status: Break Ended ‚úÖ";
          todayLogs.break.push({ type: 'out', time: now });
          openPeriods.break = null;
        } else if (action === 'startextra') {
          document.getElementById("status").innerText = "Status: Extra Hours Started ‚ûï";
          todayLogs.extra.push({ type: 'in', time: now });
          openPeriods.extra = now;
        } else if (action === 'endextra') {
          document.getElementById("status").innerText = "Status: Extra Hours Ended üõë";
          todayLogs.extra.push({ type: 'out', time: now });
          openPeriods.extra = null;
        }

        renderDayLog();

        // Store data directly in the per-employee table
        fetch(`${API}/attendance/clock`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ employee: employeeName, action })
        })
        .then(r => r.json())
        .then(j => {
          document.getElementById("msg").innerText = j.message;
          // Refresh month grid after any punch
          loadMonthData();
        })
        .catch(e => document.getElementById("msg").innerText = '‚ùå '+e);
      }

      // Helper to render log sections with running total
      function renderDayLog() {
        function renderSection(arr, label) {
          let entries = [], totalMin = 0, isOpen = false, lastTime = null;
          arr.forEach(ev => {
            let tstr = ev.time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            entries.push(`<div class="log-entry">${tstr} - ${ev.type === 'in' ? 'Start' : 'End'}</div>`);
          });
          totalMin = getCategoryTotalMinutes(label);
          return `
            <div class="log-title">${label.charAt(0).toUpperCase() + label.slice(1)}:</div>
            ${entries.length ? entries.join('') : '<div class="log-entry" style="color:#aaa">‚Äî</div>'}
            <div class="log-total">Total: ${formatDuration(totalMin)}</div>
          `;
        }
        document.getElementById('main-log').innerHTML = renderSection(todayLogs.main, 'main');
        document.getElementById('break-log').innerHTML = renderSection(todayLogs.break, 'break');
        document.getElementById('extra-log').innerHTML = renderSection(todayLogs.extra, 'extra');
      }

      // Calculate total minutes for each category (main, break, extra)
      function getCategoryTotalMinutes(category, now = null, ignoreOpen = false) {
        let logs = todayLogs[category];
        let total = 0;
        let last = null;
        logs.forEach(ev => {
          if (ev.type === 'in') last = ev.time;
          else if (ev.type === 'out' && last) {
            total += (ev.time - last) / 60000; // ms to min
            last = null;
          }
        });
        // If currently open (no out after in), add till now (unless ignoreOpen)
        if (!ignoreOpen && last && (now || new Date())) {
          total += ((now || new Date()) - last) / 60000;
        }
        return Math.round(total);
      }

      // For modal: estimate current running session duration for next action
      function getCurrentDuration(action, now) {
        // For actions that start something, show total so far.
        // For actions that end something, show total if ended now.
        if (['clockin', 'startextra', 'startbreak'].includes(action)) {
          if (action === 'clockin') return getCategoryTotalMinutes('main', now, true);
          if (action === 'startbreak') return getCategoryTotalMinutes('break', now, true);
          if (action === 'startextra') return getCategoryTotalMinutes('extra', now, true);
        } else {
          // clockout/endbreak/endextra
          if (action === 'clockout') return getCategoryTotalMinutes('main', now, false);
          if (action === 'endbreak') return getCategoryTotalMinutes('break', now, false);
          if (action === 'endextra') return getCategoryTotalMinutes('extra', now, false);
        }
        return 0;
      }

      function formatDuration(mins) {
        if (mins <= 0) return '0 min';
        let h = Math.floor(mins / 60);
        let m = mins % 60;
        return (h ? `${h}h ` : '') + (m ? `${m}min` : (h ? '' : '0 min'));
      }

      // ‚Äî‚Äî TAB logic ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
      document.getElementById('tabDaily').onclick  = () => switchTab('daily');
      document.getElementById('tabMonth').onclick  = () => switchTab('month');

      function switchTab(which){
        document.getElementById('tabDaily').classList.toggle('active', which==='daily');
        document.getElementById('tabMonth').classList.toggle('active', which==='month');
        document.getElementById('dailyView').style.display  = which==='daily' ? 'block':'none';
        document.getElementById('monthView').style.display  = which==='month' ? 'block':'none';
        if (which==='month') loadMonthData();
      }

      // ‚Äî‚Äî load month summary + table ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
      function loadMonthData(){
        // 1) Summary (days, hours, DH)
        fetch(`${API}/attendance/summary?employee=${employeeName}`)
          .then(r => r.json())
          .then(s => {
            document.getElementById('monthSummary').innerHTML =
              `<strong>${s.month}</strong> ‚Äì Days <b>${s.days}</b> ‚Ä¢ Hours <b>${s.hours}</b> ‚Ä¢ Earned <b>${s.earned} DH</b>`;
          })
          .catch(e => document.getElementById('monthSummary').innerText = '‚ùå '+e);

        // 2) Full grid
        fetch(`${API}/attendance/month-grid?employee=${employeeName}`)
          .then(r => r.json())
          .then(drawMonthTable)
          .catch(e => document.getElementById('monthTable').innerText = '‚ùå '+e);
      }

      function drawMonthTable(data){
        let html = '<table><thead><tr>';
        data.header.forEach(h => html += `<th>${h}</th>`);
        html += '</tr></thead><tbody>';
        data.rows.forEach(r => {
          html += '<tr>';
          r.forEach(c => html += `<td>${formatTableCell(c)}</td>`);
          html += '</tr>';
        });
        html += '</tbody></table>';
        document.getElementById('monthTable').innerHTML = html;
      }

      function formatTableCell(val){
        if(val === null || val === undefined) return '';
        if(!isNaN(val) && val !== ''){
          let num = parseFloat(val);
          if(num >= 0 && num < 1){
            let total = Math.round(num * 24 * 60);
            let h = String(Math.floor(total / 60)).padStart(2,'0');
            let m = String(total % 60).padStart(2,'0');
            return `${h}:${m}`;
          }
        }
        return val;
      }
    </script>
  </body>
</html>
